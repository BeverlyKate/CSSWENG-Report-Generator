<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/home.css">
    <script src="/src/home_reportBtn.js" defer></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>

<body>
    <div class="overlay-holder">
        <div class="popup"></div>
        <div class="dark-overlay"></div>
    </div>

    <header>
        <div class="left">
            <div id="CompanyLogo">
                <img src="/images/Btn_Logo.png">
            </div>
            <h2 class="Title">Generate Report </h2>
            <h3></h3>
        </div>
        <div class="right">
            <div class="Profile"></div>
        </div>
    </header>
    <hr class="line1">
    <hr class="line2">  
    <div class="reports-menu">
        <div class="btn-report-holder" data-report="IQPM">
            <div>
                <img class="report-icon" src="/images/IQPM.svg" alt="Item Quantity per Model"/>  
                <div class="report-name">ITEM QUANTITY PER MODEL</div>
            </div>
        </div>
        <div class="btn-report-holder"  data-report="TDPM">
            <div>
                <img class="report-icon" src="/images/TDPM.svg" alt="Top Defects Per Model"/>  
                <div class="report-name">TOP DEFECTS PER MODEL</div>
            </div>
        </div>
        <div class="btn-report-holder" data-report="PTPM">
            <div>
                <img class="report-icon" src="/images/PTPM.svg" alt="Pending Tasks per Model"/>  
                <div class="report-name">PENDING TASKS PER MODEL</div>
            </div>
        </div>
    </div>

    <form id="form" action="/" method="post" enctype="multipart/form-data">
        <input type="file" name="filetoupload" id="filetoupload"><br>
        <input type="submit" id="submit">
    </form>
    <script>
        function blob2file(blobData) {
            const fd = new FormData();
            fd.set('a', blobData);
            return fd.get('a');
        }
        $(document).ready(function () {
            
            $('#submit').click(async function (e) {
                e.preventDefault();
                // var formData = new FormData( $('#form')[0]);
                // console.log(formData);
                
                var file = $('#form')[0][0].files[0];

                console.log(file);
                console.log(file instanceof Blob);
                console.log(typeof(file));
                var workbook = XLSX.read(await file.arrayBuffer(), { type: "array" });

                console.log("name = " + file.name);
                console.log(workbook);
                console.log(workbook.Sheets.Sheet1[1]);
                console.log(workbook.Strings.Count);
                var wbString = JSON.stringify(workbook.Strings)
                var parsedWbString = JSON.parse(wbString);
                console.log("wb string 0 = " + wbString);
                console.log("parsed wb string = " + JSON.stringify(parsedWbString[0].t));
                var wopts = { bookType:'xlsx', bookSST:false, type:'base64' };
                var wbout = XLSX.write(workbook,wopts);
                //RESTRICT TO EXCEL FILE ONLY
                console.log(typeof(wbout));
                console.log(wbout instanceof Blob);
                var blob = new Blob([wbout], {type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});
                var formData = new FormData();


                const wbValues = [];
                for(var i = 0; i != workbook.Strings.Count; i++) {
                    wbValues[i] = workbook.Strings[i].t;
                    console.log("yo");
                }
                for(var i in workbook.Sheets.Sheet1) {
                    console.log(workbook.Sheets.Sheet1[i]);
                    console.log(i);
                }
                console.log(wbValues);
                wbValuesJson = JSON.stringify(wbValues);
                
                // formData.append('filetoupload', blob, 'test.xlsx');
                formData.append('file', file.name);
                formData.append('data', wbout);
                formData.append('excelValues', wbValuesJson)

                $.ajax({
                        url: '/importFile',  
                        type: 'POST',
                        data: formData,
                        success:function(data){
                            console.log(data);
                        },
                        cache: false,
                        contentType: false,
                        processData: false
                });
            });
        });
    </script>
</body>